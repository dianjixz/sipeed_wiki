<!DOCTYPE html>
<html lang="zh-CN"  class="" >
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="keywords" content="MaixPy3,  maix.nn,  MaixPy3运行模型,  maix.nn API, ">
    <meta name="description" content="MaixPy3 nn模块 API文档, 以及使用说明">
    <meta name="generator" content="teedoc">
    <meta name="theme" content="teedoc-plugin-theme-default">
    
    <meta name="markdown-generator" content="teedoc-plugin-markdown-parser">
    
    <link rel="stylesheet" href="/static/css/theme_default/prism.min.css" type="text/css"/>
    
    <link rel="stylesheet" href="/static/css/theme_default/viewer.min.css" type="text/css"/>
    
    <link rel="stylesheet" href="/static/css/theme_default/dark.css" type="text/css"/>
    
    <link rel="stylesheet" href="/static/css/theme_default/light.css" type="text/css"/>
    
    <script src="/static/js/theme_default/split.js"></script>
    
    <script src="/static/js/theme_default/jquery.min.js"></script>
    
    <script src="/static/js/theme_default/pre_main.js"></script>
    
    <link rel="stylesheet" href="/static/css/search/style.css" type="text/css"/>
    
    <script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?9cb07365544a53067c56c346c838181a";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>
    
    <link rel="stylesheet" href="/static/css/gitalk/gitalk.css" type="text/css"/>
    
    <link rel="stylesheet" href="/static/css/gitalk/custom_gitalk.css" type="text/css"/>
    
    <link rel="stylesheet" href="/static/css/custom.css" type="text/css"/>
    
    <title>MaixPy3 nn模块(maix.nn) - Sipeed Wiki</title>
</head>
<body class="type_doc">
    <div id="navbar">
        <div id="navbar_menu">
            <a class="site_title" href="/">
                
                    <img class="site_logo" src="/static/image/logo.svg" alt="sipeed wiki logo">
                
                
                    <h2>wiki</h2>
                
        </a>
            <a id="navbar_menu_btn"></a>
        </div>
        <div id="navbar_items">
            <div>
                <ul id="nav_left">
<li class=""><a  href="/">首页</a></li>
<li class=""><a target="_blank" href="https://www.sipeed.com">矽速官网</a></li>
<li class="sub_items active_parent"><a >开源软件</a><ul><li class=""><a  href="/soft/maixpy/zh/">MaixPy</a></li>
<li class="active"><a  href="/soft/maixpy3/zh/">MaixPy3</a></li>
<li class=""><a  href="/soft/maixduino/zh/">MaixDuino</a></li>
<li class=""><a  href="/soft/Lichee/zh/">Lichee</a></li>
<li class=""><a  href="/soft/longan/zh/index.html">Longan</a></li>
<li class=""><a  href="/soft/Tang/zh/index_bak.html">Tang</a></li>
</ul>
</li>
<li class="sub_items "><a >开源硬件</a><ul><li class=""><a  href="/hardware/zh/maix/index.html">Maix-I</a></li>
<li class=""><a  href="/hardware/zh/maixII/index.html">Maix-II</a></li>
<li class=""><a  href="/hardware/zh/lichee/index.html">Lichee Pi</a></li>
<li class=""><a  href="/hardware/zh/tang/index.html">Tang</a></li>
<li class=""><a  href="/hardware/zh/longan/Nano/Longan_nano.html">Longan</a></li>
<li class=""><a  href="/hardware/zh/modules_spmod/spmod_extender.html">SP-Mod</a></li>
</ul>
</li>
<li class="sub_items "><a >商业产品</a><ul><li class=""><a  href="/hardware/maixface/zh/">Maix Face</a></li>
</ul>
</li>
<li class="sub_items "><a >云平台</a><ul><li class=""><a target="_blank" href="https://www.maixhub.com">Maixhub 模型训练平台</a></li>
<li class=""><a target="_blank" href="https://www.maixhub.com/onlinecompiler">固件在线编译</a></li>
</ul>
</li>
<li class=""><a  href="/community.html">社区</a></li>
<li class=""><a  href="/store.html">商城</a></li>
</ul>

            </div>
            <div>
                <ul id="nav_right">
<li class="sub_items "><a  href="">Language: 中文</a><ul><li class="active"><a  href="/soft/maixpy3/zh/">中文</a></li>
<li class=""><a  href="/soft/maixpy3/en/">English</a></li>
</ul></li>
</ul>

                <ul class="nav_plugins"><li><a id="google_translate_element"><img class="icon" src="/static/image/google_translate/translate.svg"/>Translate</a></li></ul><ul class="nav_plugins"><li><a id="themes" class="light"></a></li></ul><ul class="nav_plugins"><li><a id="search"><span class="icon"></span><span class="placeholder">搜索</span>
                            <div id="search_hints">
                                <span id="search_input_hint">输入关键词，多关键词空格隔开</span>
                                <span id="search_loading_hint">正在加载，请稍候。。。</span>
                                <span id="search_download_err_hint">下载文件失败，请刷新重试或检查网络</span>
                                <span id="search_other_docs_result_hint">来自其它文档的结果</span>
                                <span id="search_curr_doc_result_hint">当前文档搜索结果</span>
                            </div></a></li></ul>
            </div>
        </div>
    </div>
    <div id="wrapper">
        <div id="sidebar_wrapper">
            <div id="sidebar">
                <div id="sidebar_title">
                    
                </div>
                <ul class="show">
<li class="not_active with_link"><a href="/soft/maixpy3/zh/index.html"><span class="label">什么是 MaixPy3 ？</span><span class="sub_indicator sub_indicator_collapsed"></span></a><ul class="">
<li class="not_active with_link"><a href="/soft/maixpy3/zh/origin/python.html"><span class="label">什么是 Python 编程语言？</span><span class=""></span></a></li>
<li class="not_active with_link"><a href="/soft/maixpy3/zh/origin/difference.html"><span class="label">MaixPy 与 MaixPy3 的区别</span><span class=""></span></a></li>
</ul>
</li>
<li class="not_active no_link"><a><span class="label">新手上路</span><span class="sub_indicator sub_indicator_collapsed"></span></a><ul class="">
<li class="not_active with_link"><a href="/soft/maixpy3/zh/guide/project.html"><span class="label">项目使用说明</span><span class=""></span></a></li>
<li class="not_active with_link"><a href="/soft/maixpy3/zh/guide/feedback.html"><span class="label">如何反馈问题</span><span class=""></span></a></li>
<li class="not_active with_link"><a href="/soft/maixpy3/zh/guide/participate.html"><span class="label">如何参与项目</span><span class=""></span></a></li>
</ul>
</li>
<li class="not_active no_link"><a><span class="label">如何安装 MaixPy3 </span><span class="sub_indicator"></span></a><ul class="show">
<li class="not_active with_link"><a href="/soft/maixpy3/zh/install/linux_x86_64/index.html"><span class="label">Linux x86_64</span><span class=""></span></a></li>
<li class="not_active no_link"><a><span class="label">除此之外？</span><span class="sub_indicator sub_indicator_collapsed"></span></a><ul class="">
<li class="not_active with_link"><a href="/soft/maixpy3/zh/install/others/develop.html"><span class="label">MaixPy3开发文档</span><span class=""></span></a></li>
<li class="not_active with_link"><a href="/soft/maixpy3/zh/install/others/platform.html"><span class="label">如何适配更多产品</span><span class="sub_indicator sub_indicator_collapsed"></span></a><ul class="">
<li class="not_active with_link"><a href="/soft/maixpy3/zh/install/others/platform/develop_linux_x86_64.html"><span class="label">linux_x86_64</span><span class=""></span></a></li>
<li class="not_active with_link"><a href="/soft/maixpy3/zh/install/others/platform/develop_v831.html"><span class="label">v831</span><span class=""></span></a></li>
<li class="not_active with_link"><a href="/soft/maixpy3/zh/install/others/platform/develop_rv1126.html"><span class="label">rv1126</span><span class=""></span></a></li>
</ul>
</li>
<li class="not_active with_link"><a href="/soft/maixpy3/zh/install/others/product.html"><span class="label">如何提交你的产品</span><span class=""></span></a></li>
</ul>
</li>
</ul>
</li>
<li class="not_active no_link"><a><span class="label">常用的开发工具</span><span class="sub_indicator sub_indicator_collapsed"></span></a><ul class="">
<li class="not_active with_link"><a href="/soft/maixpy3/zh/tools/mobaxterm.html"><span class="label">MobaXterm</span><span class=""></span></a></li>
<li class="not_active with_link"><a href="/soft/maixpy3/zh/tools/jupyter.html"><span class="label">Jupyter</span><span class=""></span></a></li>
<li class="not_active with_link"><a href="/soft/maixpy3/zh/tools/vscode.html"><span class="label">VSCode</span><span class=""></span></a></li>
<li class="not_active with_link"><a href="/soft/maixpy3/zh/tools/pyqt_rtsp.html"><span class="label">pyqt_rtsp</span><span class=""></span></a></li>
</ul>
</li>
<li class="not_active no_link"><a><span class="label">一些使用案例</span><span class="sub_indicator sub_indicator_collapsed"></span></a><ul class="">
<li class="not_active with_link"><a href="/soft/maixpy3/zh/usage/00_hello_world.html"><span class="label">[00] 你好，世界。</span><span class=""></span></a></li>
<li class="not_active with_link"><a href="/soft/maixpy3/zh/usage/01_loop_python.html"><span class="label">[01] 写好 Python 代码</span><span class=""></span></a></li>
<li class="not_active with_link"><a href="/soft/maixpy3/zh/usage/02_blink_led.html"><span class="label">[02] 闪烁 LED 吧！</span><span class=""></span></a></li>
<li class="not_active with_link"><a href="/soft/maixpy3/zh/usage/03_key_led.html"><span class="label">[03] 按下按键开关灯</span><span class=""></span></a></li>
<li class="not_active with_link"><a href="/soft/maixpy3/zh/usage/04_display_screen.html"><span class="label">[04] 把图片显示到屏幕</span><span class=""></span></a></li>
<li class="not_active with_link"><a href="/soft/maixpy3/zh/usage/05_camera_capture.html"><span class="label">[05] 捕获摄像头一帧图片</span><span class=""></span></a></li>
<li class="not_active with_link"><a href="/soft/maixpy3/zh/usage/06_training_model.html"><span class="label">[06] 训练 AI 模型</span><span class=""></span></a></li>
<li class="not_active with_link"><a href="/soft/maixpy3/zh/usage/07_verify_model.html"><span class="label">[07] 输入图像验证模型</span><span class=""></span></a></li>
<li class="not_active with_link"><a href="/soft/maixpy3/zh/usage/08_V831_resnet.html"><span class="label">[08]V831使用resnet18模型</span><span class=""></span></a></li>
<li class="not_active with_link"><a href="/soft/maixpy3/zh/usage/09_Edge_detection.html"><span class="label">[09]边缘检测</span><span class=""></span></a></li>
</ul>
</li>
<li class="active_parent no_link"><a><span class="label">内置模块说明</span><span class="sub_indicator"></span></a><ul class="show">
<li class="active_parent no_link"><a><span class="label">Maix 模块</span><span class="sub_indicator"></span></a><ul class="show">
<li class="not_active with_link"><a href="/soft/maixpy3/zh/module/maix/display.html"><span class="label">display</span><span class=""></span></a></li>
<li class="not_active with_link"><a href="/soft/maixpy3/zh/module/maix/camera.html"><span class="label">camera</span><span class=""></span></a></li>
<li class="not_active with_link"><a href="/soft/maixpy3/zh/module/maix/rpycs.html"><span class="label">rpycs</span><span class=""></span></a></li>
<li class="active with_link"><a href="/soft/maixpy3/zh/module/maix/nn.html"><span class="label">nn</span><span class=""></span></a></li>
</ul>
</li>
<li class="not_active no_link"><a><span class="label">Linux 模块</span><span class="sub_indicator sub_indicator_collapsed"></span></a><ul class="">
<li class="not_active with_link"><a href="/soft/maixpy3/zh/module/linux/gpio.html"><span class="label">GPIO</span><span class=""></span></a></li>
<li class="not_active with_link"><a href="/soft/maixpy3/zh/module/linux/i2c.html"><span class="label">I2C</span><span class=""></span></a></li>
<li class="not_active with_link"><a href="/soft/maixpy3/zh/module/linux/spi.html"><span class="label">SPI</span><span class=""></span></a></li>
<li class="not_active with_link"><a href="/soft/maixpy3/zh/module/linux/input.html"><span class="label">Iuput</span><span class=""></span></a></li>
<li class="not_active with_link"><a href="/soft/maixpy3/zh/module/linux/pwm.html"><span class="label">PWM</span><span class=""></span></a></li>
<li class="not_active with_link"><a href="/soft/maixpy3/zh/module/linux/uart.html"><span class="label">UART</span><span class=""></span></a></li>
<li class="not_active with_link"><a href="/soft/maixpy3/zh/module/linux/bluetooth.html"><span class="label">Bluetooth</span><span class=""></span></a></li>
<li class="not_active with_link"><a href="/soft/maixpy3/zh/module/linux/audio.html"><span class="label">Audio</span><span class=""></span></a></li>
<li class="not_active with_link"><a href="/soft/maixpy3/zh/module/linux/usb.html"><span class="label">USB</span><span class=""></span></a></li>
</ul>
</li>
<li class="not_active no_link"><a><span class="label">C 扩展模块</span><span class="sub_indicator sub_indicator_collapsed"></span></a><ul class="">
<li class="not_active no_link"><a><span class="label">libmaix</span><span class="sub_indicator sub_indicator_collapsed"></span></a><ul class="">
<li class="not_active with_link"><a href="/soft/maixpy3/zh/module/ext/_maix.html"><span class="label">_maix</span><span class=""></span></a></li>
<li class="not_active with_link"><a href="/soft/maixpy3/zh/module/ext/_maix_display.html"><span class="label">_maix_display</span><span class=""></span></a></li>
<li class="not_active with_link"><a href="/soft/maixpy3/zh/module/ext/_maix_camera.html"><span class="label">_maix_camera</span><span class=""></span></a></li>
<li class="not_active with_link"><a href="/soft/maixpy3/zh/module/ext/_maix_nn.html"><span class="label">_maix_nn</span><span class=""></span></a></li>
</ul>
</li>
<li class="not_active with_link"><a href="/soft/maixpy3/zh/module/ext/libi2c.html"><span class="label">libi2c</span><span class=""></span></a></li>
</ul>
</li>
<li class="not_active with_link"><a href="https://docs.python.org/3/library/" ><span class="label">Python3 标准库</span><span class=""></span></a></li>
</ul>
</li>
<li class="not_active no_link"><a><span class="label">常见问题</span><span class="sub_indicator sub_indicator_collapsed"></span></a><ul class="">
<li class="not_active with_link"><a href="/soft/maixpy3/zh/question/how_to_ask.html"><span class="label">如何提交你的问题?</span><span class=""></span></a></li>
<li class="not_active with_link"><a href="/soft/maixpy3/zh/question/driver_issue.html"><span class="label">驱动安装 常见问题集合</span><span class=""></span></a></li>
<li class="not_active with_link"><a href="/soft/maixpy3/zh/question/jupyter_issue.html"><span class="label">Jupyter 常见问题集合</span><span class=""></span></a></li>
<li class="not_active with_link"><a href="/soft/maixpy3/zh/question/maixpy3_issue.html"><span class="label">MaixPy3 常见问题集合</span><span class=""></span></a></li>
</ul>
</li>
<li class="not_active with_link"><a href="/soft/maixpy3/zh/update_history.html"><span class="label">更新历史</span><span class=""></span></a></li>
</ul>

            </div>
        </div>
        <div id="article">
            <div id="menu_wrapper">
                <div id="menu">
                </div>
            </div>
            <div id="content_wrapper">
                <div id="content_body">
                    <div id="article_head">
                        <div id="article_title">
                            <h1>MaixPy3 nn模块(maix.nn)</h1>
                        </div>
                        <div id="article_tags">
                            <ul>
                            
                            </ul>
                        </div>
                        <div id="article_info">
                        <div id="article_info_left">
                            <span class="article_author">
                                
                            </span>
                            <span class="article_date">
                                
                            </span>
                        </div>
                        <div id="article_info_right">
                            
                            <div id="source_link">
                                <a href="https://github.com/sipeed/sipeed_wiki/blob/main/docs/soft/maixpy3/zh/module/maix/nn.md" target="_blank">
                                    编辑本页
                                </a>
                            </div>
                            
                        </div>
                        </div>
                    </div>
                    <div id="article_content">
                        <blockquote class="spoiler warning"><p> API 仍处于非稳定状态, 可能在未来会有小幅改动, 如果你遇到了语法错误， 记得回来看更新哦~</p>
</blockquote>
<h2 id="maix.nn-%E5%9F%BA%E6%9C%AC%E4%BD%BF%E7%94%A8%E4%BB%8B%E7%BB%8D">maix.nn 基本使用介绍</h2>
<ul>
<li>准备模型</li>
</ul>
<p>比如从 maixhub 下载, 这里以边缘检测模型为例, 先<a href="https://maixhub.com/modelInfo?modelId=24">下载模型</a>(需要先注册登录)</p>
<ul>
<li><p>准备一张 <code>224 x 224</code> 分辨率的图像, 比如这里放到了开发板文件系统的<code>/root/test.png</code>位置</p>
</li>
<li><p>运行代码, 将下面的代码保存到开发板的<code>test_model.py</code>中, 然后运行<code>python test_model.py</code></p>
</li>
</ul>
<p>其中最重要的就是<code>m = nn.load</code>和<code>m.forward()</code>两个函数, 即加载模型, 和进行模型前向推理</p>
<pre><code class="lang-python">from maix import nn, display
from PIL import Image
import numpy as np

test_jpg = &quot;/root/test.png&quot;

model = {
    &quot;param&quot;: &quot;/root/models/sobel_int8.param&quot;,
    &quot;bin&quot;: &quot;/root/models/sobel_int8.bin&quot;
}

input_size = (224, 224, 3)
output_size = (222, 222, 3)

options = {
    &quot;model_type&quot;:  &quot;awnn&quot;,
    &quot;inputs&quot;: {
        &quot;input0&quot;: input_size
    },
    &quot;outputs&quot;: {
        &quot;output0&quot;: output_size
    },
    &quot;mean&quot;: [127.5, 127.5, 127.5],
    &quot;norm&quot;: [0.0078125, 0.0078125, 0.0078125],
}
print(&quot;-- load model:&quot;, model)
m = nn.load(model, opt=options)
print(&quot;-- load ok&quot;)

print(&quot;-- read image&quot;)
img = Image.open(test_jpg).resize(input_size[:2])
print(&quot;-- read image ok&quot;)
print(&quot;-- forward model with image as input&quot;)
out = m.forward(img, quantize=True)
print(&quot;-- forward ok&quot;)
out = out.astype(np.float32).reshape(output_size)
out = (np.abs(out) * 255 / out.max()).astype(np.uint8)
img2 = Image.fromarray(out, mode=&quot;RGB&quot;)

display.show(img2)
</code></pre>
<h2 id="%E6%96%B9%E6%B3%95-maix.nn.load%28%29">方法 maix.nn.load()</h2>
<p>加载模型, 返回 <code>maix.nn.Model</code> 对象</p>
<h3 id="%E5%8F%82%E6%95%B0">参数</h3>
<ul>
<li><p><code>model_path</code>: 模型路径, 可以是字符串或者字典的形式, 目前只支持字典形式
比如:</p>
<pre><code class="lang-python">{
  &quot;param&quot;: &quot;/root/models/sobel_int8.param&quot;,
  &quot;bin&quot;: &quot;/root/models/sobel_int8.bin&quot;
}
</code></pre>
</li>
<li><p><code>opt</code>: 设置项, 字典形式, 包括了:</p>
<ul>
<li><code>model_type</code>: 模型类别, 目前仅支持 <code>awnn</code></li>
<li><code>inputs</code>: 输入层, 字典形式, 关键字是层名称, 为字符串, 如果是加密模型, 需要使用整型; 值是层形状, 为一个<code>tuple</code>类型:<code>(h, w, c)</code>. 目前只支持单层输入层(未来会支持多层输入, 欢迎提交 <code>PR</code>)
比如:<pre><code class="lang-python"># 未加密模型
&quot;inputs&quot;: {
    &quot;input0&quot;: (224, 224, 3)
}
# 加密模型
&quot;inputs&quot;: {
    0: (224, 224, 3)
}
</code></pre>
</li>
<li><code>outputs</code>: 输出层, 同理输入层. 支持多层输出</li>
<li><code>mean</code>: 如果在<code>forward</code>使参数<code>quantize=True</code>, 则会使用这个参数对输入数据进行归一化, 计算方法为<code>(x - mean) * norm</code>; 格式为<code>list</code> 或者 <code>float</code>(未支持, 欢迎提交 PR)</li>
<li><code>norm</code>: 看<code>mean</code></li>
</ul>
</li>
</ul>
<h3 id="%E8%BF%94%E5%9B%9E%E5%80%BC">返回值</h3>
<p>返回 <code>maix.nn.Model</code> 对象</p>
<h2 id="%E7%B1%BB-maix.nn.Model">类 maix.nn.Model</h2>
<p>包含了一系列神经网络操作,  <code>maix.nn.load()</code> 会返回其对象</p>
<h3 id="maix.nn.Model.forward%28%29">maix.nn.Model.forward()</h3>
<p>只能由具体的对象调用, 不能类直接调用</p>
<h4 id="%E5%8F%82%E6%95%B0">参数</h4>
<ul>
<li><code>inputs</code>: 输入, 可以是<code>Pillow</code>的<code>Image</code>对象, 也可以是<code>HWC</code>排列的<code>bytes</code>对象, 也可以是<code>HWC</code>排列的<code>numpy.ndarray</code>对象(还未支持), 多层输入使用<code>list</code>(还未支持)<blockquote class="spoiler warning"><p> 这个参数未来可能会进行优化</p>
</blockquote>
</li>
<li><p><code>quantize</code>: 为<code>True</code>, 会使用 <code>load()</code> 时 <code>opt</code> 的<code>mean norm</code>参数对数据进行归一化, 并进行<code>int8</code>量化； <code>False</code>则不会对输入数据进行处理, 则输入需要先自己手动规范量化到<code>-128~127</code>范围.</p>
<blockquote class="spoiler warning"><p> 这个参数未来可能会进行优化, 将归一化和量化分开</p>
</blockquote>
</li>
<li><p><code>layout</code>: <code>"hwc"</code> 或者 <code>"chw"</code>(默认, 推荐)</p>
</li>
<li><code>debug</code>: 输出<code>debug</code>信息, 包含了底层<code>forward</code>用时等</li>
</ul>
<h4 id="%E8%BF%94%E5%9B%9E%E5%80%BC">返回值</h4>
<p>特征图, 如果是单层输出, 是一个浮点类型的 <code>numpy.ndarray</code> 对象, 如果是多层输出, 会是一个<code>list</code>对象, 包含了多个<code>numpy.ndarray</code>对象.</p>
<h3 id="maix.nn.Model.%3Cstrong%3Edel%3C/strong%3E%28%29">maix.nn.Model.<strong>del</strong>()</h3>
<p>删除对象, 内存回收时会自动调用这个函数, 会释放模型占用的资源</p>
<pre><code class="lang-python">del m
</code></pre>
<h2 id="%E6%A8%A1%E5%9D%97-maix.nn.decoder">模块 maix.nn.decoder</h2>
<p><code>nn</code> 后处理模块, 集成了常见的模型的后处理, 使用 <code>forward</code> 进行模型推理后得到特征图输出, 使用这个模块下的方法对输出的特征图进行后处理</p>
<h3 id="%E7%B1%BB-maix.nn.decoder.Yolo2">类 maix.nn.decoder.Yolo2</h3>
<p><code>YOLO V2</code> 的后处理模块, 使用时需要创建一个对象,调用<code>run</code>方法对模型推理输出进行解码得到物体的坐标和类别.</p>
<p>等价于如下<code>python</code>伪代码:</p>
<pre><code class="lang-python">class Yolo2:
    def __init__(self, class_num, anchors, net_in_size=(224, 244), net_out_size=(7, 7)):
        pass

    def run(self, fmap, nms = 0.3, threshold = 0.5, img_size = None):
        boxes = []
        probs = []
        for x, y, w, h, _probs in valid_results:
            if img:
                x *= img_size[0]
                y *= img_size[1]
                w *= img_size[0]
                h *= img_size[1]
                x, y, w, h = int(x), int(y), int(w), int(h)
            boxes.append([x, y, w, h])  # item type is float if img_size == 0, else int type
            probs.append([max_probs_index, _probs]) # probs is list type, item type is float
        return [boxes, probs]
</code></pre>
<p>使用时:</p>
<pre><code class="lang-python">from maix.nn import decoder

labels = [&quot;A&quot;, &quot;B&quot;, &quot;C&quot;]
anchors = [1.19, 1.98, 2.79, 4.59, 4.53, 8.92, 8.06, 5.29, 10.32, 10.65]

yolo2_decoder = decoder.Yolo2(len(labels), anchors)
yolo2_decoder.run(bytes([0]*10))

...

out = m.forwar(img, layout=&quot;hwc&quot;)
boxes, probs = yolo2_decoder.run(out, thres=0.5, nms=0.3, img_size=(img.width, img.height))
for i, box in enumerate(boxes):
    class_id = probs[i][0]
    prob = probs[i][1][class_id]
    disp_str = &quot;{}:{:.2f}%&quot;.format(labels[class_id], prob*100)
    print(&quot;final box: {}, {}&quot;.format(box, disp_str))
</code></pre>
<h4 id="maix.nn.decoder.Yolo2.%3Cstrong%3Einit%3C/strong%3E%28%29">maix.nn.decoder.Yolo2.<strong>init</strong>()</h4>
<p>构造对象时会自动调用</p>
<h5 id="%E5%8F%82%E6%95%B0">参数</h5>
<ul>
<li><code>class_num</code>: 类别数量</li>
<li><code>anchors</code>: 预选框, <code>list</code> 类型, 数量为偶数, 必须要和训练时使用的<code>anchors</code> 相同, 也就是说跟模型绑定的参数, 如果你不知道, 请找提供模型的人提供</li>
<li><code>net_in_size</code>: 网络输入层分辨率, 默认<code>(224, 244)</code></li>
<li><code>net_out_size</code>: 网络输出层分辨率, 默认 <code>(7, 7)</code></li>
</ul>
<h4 id="maix.nn.decoder.Yolo2.run%28%29">maix.nn.decoder.Yolo2.run()</h4>
<p>执行解码(后处理), 只能对象进行调用, 不能类直接调用</p>
<h5 id="%E5%8F%82%E6%95%B0">参数</h5>
<ul>
<li><code>fmap</code>: 网路输出的特征图, 一般是<code>forward</code> 函数的结果</li>
<li><code>nms</code>: 非极大值抑制(Non-Maximum Suppression), 用来去掉重复的框, <code>IOU</code>(两个框的重叠区域)大于这个值就只取概率大的一个, 取值范围:<code>[0, 1]</code>, 默认值为 <code>0.3</code></li>
<li><code>threshold</code>: 置信度阈值, 大于这个值才认为物体有效, 取值范围:<code>[0, 1]</code>, 默认 <code>0.5</code></li>
<li><code>img_size</code>: 源图像大小, <code>tuple</code>类型, 比如<code>(320, 240)</code>, 这会使返回值的<code>box</code> 坐标自动计算为相对于源图的坐标, 并且类型为整型, 默认<code>None</code> 则不会计算, <code>box</code> 返回相对值(百分比), 浮点类型, 范围:<code>[0, 1]</code></li>
</ul>
<h5 id="%E8%BF%94%E5%9B%9E%E5%80%BC">返回值</h5>
<p><code>[boxes, probs]</code>, <code>list</code> 类型, 可以参考上面的使用例子, 其中:</p>
<ul>
<li><code>boxes</code>: <code>list</code> 类型, 每个元素也是一个<code>list</code>, 包含<code>[x, y, w, h]</code>, 分别代表了框左上角坐标, 以及框的宽高</li>
<li><code>probs</code>: <code>list</code> 类型, 每个元素也是一个<code>list</code>, 包含<code>[max_prob_idx, all_classes_probs]</code><ul>
<li><code>all_classes_probs</code>: <code>list</code> 类型, 包含了该框所有类别的置信度</li>
<li><code>max_prob_idx</code>: 整型, 代表了<code>all_classes_probs</code>中最大值的下标, 取值范围: <code>[0, classes_num - 1]</code></li>
</ul>
</li>
</ul>
<h2 id="%E6%A8%A1%E5%9D%97-maix.nn.app">模块 maix.nn.app</h2>
<p>应用模块， 包含了一些有意思的应用模块</p>
<h3 id="%E6%A8%A1%E5%9D%97-maix.nn.app.classifier">模块 maix.nn.app.classifier</h3>
<p>自学习分类器（视觉）， 无需训练模型， 只使用特征提取模型， 在运行时学习多个物体特征，然后即可对物体进行分类识别。 适用于简单的分类场景。</p>
<p><code>maix.nn.app.classifier</code>的<code>python</code>伪代码:</p>
<pre><code class="lang-python">class Classifier:
    def __init__(self, model, class_num, sample_num, feature_len, input_w, input_h):
        pass

    def add_class_img(self, img):
        return idx

    def add_sample_img(self, img):
        return idx

    def train(self):
        pass

    def predict(self, img):
        return idx, min_dist

    def save(self, path):
        pass

def load(model, path):
    return Classifier()
</code></pre>
<h4 id="%E7%B1%BB-Classifier">类 Classifier</h4>
<p>使用时需要指定类别数量，通过<code>add_class_img</code>函数传入物体图像来获得物体的特征值， 然后通过<code>add_sample_img</code>获取这几个类别的图像，用以对开始采集的图像特征值进行优化， <code>sample</code>的图像和开始采集的类别图像可以有一定的差异， 但是不要相差太大， 采集的顺序无所谓；
然后调用<code>train</code>方法进行训练(其实就是<code>kmeans</code> 聚类)， 就可以得到使用<code>sample</code>图像特征值优化过后的几个分类的特征值；
最后使用<code>predict</code>就可以对输入图像的类别进行识别</p>
<h5 id="%E6%9E%84%E9%80%A0%E6%96%B9%E6%B3%95%EF%BC%9A-%3Cstrong%3Einit%3C/strong%3E%28self%2C-model%2C-class_num%2C-sample_num%2C-feature_len%2C-input_w%2C-input_h%29">构造方法： <strong>init</strong>(self, model, class_num, sample_num, feature_len, input_w, input_h)</h5>
<ul>
<li>参数：<ul>
<li><code>model</code>: <code>maix.nn.Model</code>对象， 用于获得图片的特征值</li>
<li><code>class_num</code>: 要学习的物体类别数量， 比如 <code>3</code></li>
<li><code>sample_num</code>: 用以学习特征的物体数量， 比如<code>3*5 =&gt; 15</code></li>
<li><code>feature_len</code>: 特征值的长度， 取决于特征提取模型的输出形状， 比如例程使用<code>resnet18 1000 分类</code>模型， 倒数第二层输出长度是<code>512</code></li>
<li><code>input_w</code>: 输入的图像的宽度</li>
<li><code>input_h</code>: 输入的图像的高度</li>
</ul>
</li>
</ul>
<h5 id="%E6%96%B9%E6%B3%95%3A-add_class_img%28self%2C-img%29">方法: add_class_img(self, img)</h5>
<p>添加分类图片， 会自动调用模型推理获取图片的特征值</p>
<ul>
<li><p>参数：</p>
<ul>
<li><code>img</code>: 输入图像， 可以是<code>Pillow</code>的<code>Image</code>对象, 也可以是<code>HWC</code>排列的<code>bytes</code>对象</li>
</ul>
</li>
<li><p>返回值： <code>int</code> 类型, 代表返回成功添加第几个类别的特征值， 取值∈<code>[0, class_num)</code></p>
</li>
<li><p>抛出错误： 如果出现错误， 比如添加图片超过类别数量等， 会抛出错误信息</p>
</li>
</ul>
<h5 id="%E6%96%B9%E6%B3%95%3A-add_sample_img%28self%2C-img%29">方法: add_sample_img(self, img)</h5>
<p>添加样本图片， 会自动调用模型推理获取图片的特征值</p>
<ul>
<li><p>参数：</p>
<ul>
<li><code>img</code>: 输入图像， 可以是<code>Pillow</code>的<code>Image</code>对象, 也可以是<code>HWC</code>排列的<code>bytes</code>对象</li>
</ul>
</li>
<li><p>返回值： <code>int</code> 类型, 代表返回成功添加第几个样本图片的特征值， 取值∈<code>[0, sample_num)</code></p>
</li>
<li><p>抛出错误： 如果出现错误， 比如添加图片超过设置的样本数量等， 会抛出错误信息</p>
</li>
</ul>
<h5 id="%E6%96%B9%E6%B3%95%3A-train%28self%29">方法: train(self)</h5>
<p>训练样本（本质上是聚类分类）， 需要在<code>add_class_img</code>和<code>add_sample_img</code>完成后才能调用，否则会出现误差</p>
<ul>
<li>抛出错误： 如果出现错误， 比如类别或者样本采集未完成， 会抛出错误信息</li>
</ul>
<h5 id="%E6%96%B9%E6%B3%95%EF%BC%9A-predict%28self%2C-img%29">方法： predict(self, img)</h5>
<p>预测给定的图片所属的类别</p>
<ul>
<li><p>参数：</p>
<ul>
<li><code>img</code>: 输入图像， 可以是<code>Pillow</code>的<code>Image</code>对象, 也可以是<code>HWC</code>排列的<code>bytes</code>对象</li>
</ul>
</li>
<li><p>返回值：</p>
<ul>
<li><code>idx</code>: <code>int</code> 类型, 代表给定的图片的特征和这个分类最接近， 取值∈<code>[0, sample_num)</code></li>
<li><code>min_dist</code>: 图片的特征和<code>idx</code>类别的特征的距离， 距离越小则代表和该类越相似</li>
</ul>
</li>
<li><p>抛出错误： 如果出现错误， 比如参数错误等， 会抛出错误</p>
</li>
</ul>
<h5 id="%E6%96%B9%E6%B3%95%EF%BC%9A-save%28self%2C-path%29">方法： save(self, path)</h5>
<p>保存当前的特征值参数到文件， 方便断电保存并下次加载使用</p>
<ul>
<li><p>参数：</p>
<ul>
<li><code>path</code>: 保存的路径， 字符串</li>
</ul>
</li>
<li><p>抛出错误： 保存出错， 会抛出错误信息</p>
</li>
</ul>
<h4 id="%E6%96%B9%E6%B3%95-load%28model%2C-path%29">方法 load(model, path)</h4>
<p>加载保存的特征值参数文件， 获得<a href="#类-Classifier">类 Classifier</a>的对象， 加载完成后可直接使用<code>predict</code>函数</p>
<ul>
<li><p>参数：</p>
<ul>
<li><code>model</code>: <code>maix.nn.Model</code>对象， 用于获得图片的特征值， 需要和保存的时候使用的模型相同</li>
<li><code>path</code>: 保存参数的路径</li>
</ul>
</li>
<li><p>返回值： 获得<a href="#类-Classifier">类 Classifier</a>的对象</p>
</li>
</ul>

                    </div>
                </div>
                <div id="previous_next">
                    <div id="previous">
                        
                        <a href="/soft/maixpy3/zh/module/maix/rpycs.html">
                            <span class="icon"></span>
                            <span class="label">rpycs</span>
                        </a>
                        
                    </div>
                    <div id="next">
                        
                        <a href="/soft/maixpy3/zh/module/linux/gpio.html">
                            <span class="label">GPIO</span>
                            <span class="icon"></span>
                        </a>
                        
                    </div>
                </div>
                <div id="comments-container"></div>
            </div>
            <div id="toc">
                <div id="toc_content">
                        
                </div>
            </div>
        </div>
    </div>
    <a id="to_top" href="#"></a>
    <div id="doc_footer">
        <div id="footer">
            <div id="footer_top">
                <ul>
<li><a>链接</a><ul><li><a target="_blank" href="https://www.sipeed.com">Sipeed</a></li>
<li><a target="_blank" href="https://bbs.sipeed.com/">BBS 论坛</a></li>
<li><a target="_blank" href="https://maixhub.sipeed.com/">Maixhub</a></li>
<li><a target="_blank" href="https://sipeed.taobao.com/">Sipeed 淘宝</a></li>
<li><a target="_blank" href="https://github.com/neutree/teedoc">网站使用 teedoc 生成</a></li>
</ul>
</li>
<li><a>网站统计</a><ul><li><a target="_blank" href="https://tongji.baidu.com/web/welcome/ico?s=9cb07365544a53067c56c346c838181a">百度统计</a></li>
<li><a  href="/sitemap.xml">网站地图</a></li>
</ul>
</li>
<li><a>源码</a><ul><li><a target="_blank" href="https://github.com/sipeed/sipeed_wiki">文档源文件</a></li>
<li><a target="_blank" href="https://github.com/sipeed">开源项目源码</a></li>
</ul>
</li>
<li><a>关注我们</a><ul><li><a target="_blank" href="https://github.com/sipeed">github</a></li>
<li><a target="_blank" href="https://twitter.com/SipeedIO">twitter</a></li>
<li><a target="_blank" href="https://sipeed.taobao.com/">淘宝</a></li>
<li><a  href="/community.html">更多</a></li>
</ul>
</li>
<li><a>联系我们</a><ul><li><a>电话: +86 0755-27808509</a>
</li>
<li><a>商业支持: support@sipeed.com</a>
</li>
<li><a>地址: 深圳市宝安区新湖路4008号蘅芳科技办公大厦A座-2101C</a>
</li>
<li><a  href="/join_us.html">加入我们</a></li>
</ul>
</li>
</ul>

            </div>
            <div id="footer_bottom">
                <ul>
<li><a target="_blank" href="https://www.sipeed.com">©2018-2021 深圳矽速科技有限公司</a></li>
<li><a target="_blank" href="https://beian.miit.gov.cn/#/Integrated/index">粤ICP备19015433号-1</a></li>
</ul>

            </div>
        </div>
    </div>
</body>

    <script type="text/javascript">
                var transLoaded = false;
                var loading = false;
                var domain = "/";
                var domainDefault = domain;
                var storeDomain = localStorage.getItem("googleTransDomain");
                if(storeDomain){
                    domain = storeDomain;
                }
                function getUrl(domain){
                    if(domain == "/")
                        return "/static/js/google_translate/element.js?cb=googleTranslateElementInit";
                    else
                        return "https://" + domain + "/translate_a/element.js?cb=googleTranslateElementInit";
                }
                var url = getUrl(domain);
                function googleTranslateElementInit() {
                    new google.translate.TranslateElement({pageLanguage: "auto", layout: google.translate.TranslateElement.InlineLayout.SIMPLE}, 'google_translate_element');
                }
                function loadJS( url, callback ){
                    var script = document.createElement('script');
                    fn = callback || function(){ };
                    script.type = 'text/javascript';
                    if(script.readyState){
                        script.onreadystatechange = function(){
                            if( script.readyState == 'loaded' || script.readyState == 'complete' ){
                                script.onreadystatechange = null;
                                fn();
                            }
                        };
                    }else{
                        script.onload = function(){
                            fn();
                        };
                    }
                    script.src = url;
                    document.getElementsByTagName('head')[0].appendChild(script);
                }
                function removeHint(){
                    var hint = document.getElementById("loadingTranslate");
                    if(hint){
                        hint.remove();
                    }
                }
                var btn = document.getElementById("google_translate_element");
                btn.onclick = function(){
                    if(transLoaded) return;
                    if(loading){
                        var flag = confirm("loading from " + domain + ", please wait, or change domain?");
                        if(flag){
                            newDomain = prompt("domain, default: " + domainDefault + ", now: " + domain);
                            if(newDomain){
                                domain = newDomain;
                                console.log(domain);
                                url = getUrl(domain);
                                loadJS(url, function(){
                                    localStorage.setItem("googleTransDomain", domain);
                                    removeHint()
                                    transLoaded = true;
                                });
                            }
                        }
                        return;
                    }
                    btn.innerHTML = '<span id="loadingTranslate"><img class="icon" src="/static/image/google_translate/translate.svg"/>Loading ...</span>';
                    loading = true;
                    loadJS(url, function(){
                        localStorage.setItem("googleTransDomain", domain);
                        removeHint()
                        transLoaded = true;
                    });
                }
                </script>
            

    <script src="/static/js/theme_default/tocbot.min.js"></script>

    <script src="/static/js/theme_default/main.js"></script>

    <script src="/static/js/theme_default/viewer.min.js"></script>

    <script src="/static/css/theme_default/prism.min.js"></script>

    <script src="/static/js/search/search_main.js"></script>

    <script src="/static/js/gitalk/gitalk.min.js"></script>

    <script src="/static/js/gitalk/main.js"></script>

    <script src="/static/js/custom.js"></script>

</html>